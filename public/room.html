<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TempChat Room</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    margin: 0;
    background: #f5f5f7;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  h3 {
    text-align: center;
    margin: 10px 0;
    color: #333;
  }
  #main { flex: 1; display: flex; overflow: hidden; }
  #chat {
    flex: 3;
    overflow-y: auto;
    padding: 10px;
    display: flex;
    flex-direction: column;
    border-right: 1px solid #ddd;
  }
  .bubble {
    max-width: 80%;
    padding: 10px 14px;
    border-radius: 16px;
    margin: 6px 0;
    line-height: 1.4em;
    word-wrap: break-word;
    display: inline-block;
    position: relative;
  }
  .mine {
    align-self: flex-end;
    background: var(--mycolor);
    color: white;
    border-bottom-right-radius: 5px;
  }
  .theirs {
    align-self: flex-start;
    background: var(--theircolor);
    color: black;
    border-bottom-left-radius: 5px;
  }
  .system {
    align-self: center;
    font-size: 0.85em;
    color: #888;
  }
  .date-separator {
    align-self: center;
    background: #ddd;
    color: #333;
    font-size: 0.8em;
    padding: 4px 10px;
    border-radius: 10px;
    margin: 10px 0;
  }
  .seen-list {
    font-size: 0.65em;
    opacity: 0.8;
    text-align: right;
    margin-top: 3px;
  }
  #users {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background: #f0f0f0;
  }
  #users h4 { margin-top: 0; }
  .user-item { margin: 4px 0; font-size: 0.9em; }
  #controls {
    display: flex;
    padding: 10px;
    background: white;
    border-top: 1px solid #ddd;
  }
  #msg {
    flex: 1;
    padding: 10px;
    border-radius: 20px;
    border: 1px solid #ccc;
    outline: none;
  }
  #send, #end {
    padding: 10px 14px;
    margin-left: 6px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
  }
  #send { background: #007aff; color: white; }
  #end { background: #ff3b30; color: white; }
</style>
</head>
<body>
<h3 id="title">Joining...</h3>
<div id="main">
  <div id="chat"></div>
  <div id="users">
    <h4>Users</h4>
    <div id="userList"></div>
    <div id="typingIndicator" style="font-style: italic; color: #666; margin: 4px 0;"></div>
  </div>
</div>
<div id="controls">
  <input id="msg" placeholder="Write a message..." />
  <button id="send">Send</button>
  <button id="end">End</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const qs = new URLSearchParams(window.location.search);
const roomId = qs.get('roomId');
const sessionId = qs.get('sessionId');
const name = qs.get('name') || 'Guest';
const title = document.getElementById('title');
const chat = document.getElementById('chat');
const send = document.getElementById('send');
const msgInput = document.getElementById('msg');
const endBtn = document.getElementById('end');
const userList = document.getElementById('userList');

if (!roomId || !sessionId) {
  title.textContent = "Invalid link. Missing parameters.";
  document.getElementById('controls').style.display='none';
  throw new Error('missing params');
}

const password = prompt('Enter chat password (ask partner)');

let myColor = localStorage.getItem('myColor');
if (!myColor) {
  const colors = ['#007AFF','#34C759','#FF9500','#FF2D55','#5AC8FA','#AF52DE'];
  myColor = colors[Math.floor(Math.random()*colors.length)];
  localStorage.setItem('myColor', myColor);
}
document.documentElement.style.setProperty('--mycolor', myColor);
document.documentElement.style.setProperty('--theircolor', '#e6e6eb');

fetch(`/api/validate?roomId=${encodeURIComponent(roomId)}&sessionId=${encodeURIComponent(sessionId)}`)
  .then(r=>r.json())
  .then(data=>{
    if(!data.ok){title.textContent="Invalid or expired session.";document.getElementById('controls').style.display='none';return;}
    title.textContent=`Room ${roomId} ‚Äî ${data.name}`;
    initSocket();
  });

let lastDateShown = null;

function append(msg) {
  const msgDate = new Date(msg.at);
  const dateStr = msgDate.toLocaleDateString([], { day: 'numeric', month: 'long', year: 'numeric' });

  if (lastDateShown !== dateStr) {
    const sep = document.createElement('div');
    sep.className = 'date-separator';
    sep.textContent = `üìÖ ${dateStr}`;
    chat.appendChild(sep);
    lastDateShown = dateStr;
  }

  const d = document.createElement('div');
  d.classList.add('bubble');
  const time = msgDate.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

  if (msg.from === 'System') {
    d.classList.add('system');
    d.textContent = msg.text;
  } else if (msg.from === name) {
    d.classList.add('mine');
    d.innerHTML = `${msg.text}<div style="font-size:0.7em;opacity:0.8;text-align:right;">${time}</div>`;
    if (msg.seenBy?.length) {
      const seenDiv = document.createElement('div');
      seenDiv.className = 'seen-list';
      seenDiv.textContent = 'Seen by: ' + msg.seenBy.join(', ');
      d.appendChild(seenDiv);
    }
  } else {
    d.classList.add('theirs');
    d.innerHTML = `<b>${msg.from}:</b> ${msg.text}<div style="font-size:0.7em;opacity:0.6;text-align:left;">${time}</div>`;
    if (msg.color) d.style.background = msg.color;
  }

  d.dataset.id = msg.id;
  chat.appendChild(d);
  chat.scrollTop = chat.scrollHeight;
}

function renderUsers(users){
  userList.innerHTML='';
  Object.values(users).forEach(u=>{
    const d=document.createElement('div');
    d.className='user-item';
    let status;
    if(u.isOnline) status='<span style="color:green">‚óè Online</span>';
    else {
      const diff=Date.now()-u.lastSeen;
      if(diff<60000) status='last seen just now';
      else if(diff<3600000) status=`last seen ${Math.floor(diff/60000)} min ago`;
      else if(diff<86400000) status=`last seen ${Math.floor(diff/3600000)} hr ago`;
      else status=`last seen ${Math.floor(diff/86400000)} days ago`;
    }
    d.innerHTML=`<span style="color:${u.color}">‚óè</span> ${u.name} ‚Äî ${status}`;
    userList.appendChild(d);
  });
}

function initSocket(){
  const socket = io();
  const typingIndicator=document.getElementById('typingIndicator');
  let typingTimeout;

  socket.on('connect',()=>{
    socket.emit('join',{roomId,sessionId,displayName:name,password,color:myColor});
  });

  msgInput.addEventListener('input',()=>{
    socket.emit('typing',{roomId,name});
    clearTimeout(typingTimeout);
    typingTimeout=setTimeout(()=>socket.emit('stop_typing',{roomId,name}),1000);
  });

  socket.on('user_typing',({name})=>typingIndicator.textContent=`${name} is typing...`);
  socket.on('user_stop_typing',()=>typingIndicator.textContent='');

  socket.on('history',arr=>arr.forEach(append));
  socket.on('joined',()=>append({from:'System',text:'You joined the room',at:Date.now()}));
  socket.on('user_joined',u=>append({from:'System',text:`${u.name} joined`,at:Date.now()}));
  socket.on('user_left',u=>append({from:'System',text:`${u.name} left`,at:Date.now()}));
  socket.on('message',msg=>{
    append(msg);
    if(msg.from!==name) socket.emit('message_seen',{roomId,messageId:msg.id,viewer:name});
  });
  socket.on('update_seen',({messageId,seenBy})=>{
    const msgEl=document.querySelector(`[data-id="${messageId}"]`);
    if(msgEl && msgEl.classList.contains('mine')){
      let seenDiv=msgEl.querySelector('.seen-list');
      if(!seenDiv){
        seenDiv=document.createElement('div');
        seenDiv.className='seen-list';
        msgEl.appendChild(seenDiv);
      }
      seenDiv.textContent='Seen by: '+seenBy.join(', ');
    }
  });

  socket.on('join_error',e=>{
    title.textContent='Join error: '+e;
    document.getElementById('controls').style.display='none';
  });

  socket.on('last_active',renderUsers);
  setInterval(()=>socket.emit('refresh_users',{roomId}),60000);

  send.addEventListener('click',()=>{
    const text=msgInput.value.trim();
    if(!text)return;
    socket.emit('message',{roomId,text});
    msgInput.value='';
  });

  msgInput.addEventListener('keypress',e=>{if(e.key==='Enter')send.click();});
  endBtn.addEventListener('click',async()=>{
    const res=await fetch('/api/end',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roomId,sessionId})});
    const j=await res.json();
    if(j.ok){append({from:'System',text:'You ended the session',at:Date.now()});document.getElementById('controls').style.display='none';}
    else alert('Failed: '+(j.error||'unknown'));
  });
}
</script>
</body>
</html>
